#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <time.h>
#include "lz77.h"

// #define INPUT_SIZE 16384
// #define OUTPUT_SIZE 16384

#define INPUT_SIZE 1024
#define OUTPUT_SIZE 1024


int main(int argc, char *argv[])
{
    // DEBUG
    // UCHAR _in[] =
    // {117,230,141,112,19,28,186,51,159,75,25,192,3,168,55,25,142,149,143,167,96,81,74,125,113,254,207,47,43,236,63,159,211,204,16,221,223,193,10,128,6,34,65,8,201,111,32,80,5,167,238,100,247,58,216,105,49,169,143,91,142,197,241,91,138,249,57,107,187,66,234,192,100,36,192,38,146,215,118,142,127,101,234,111,150,195,207,191,101,95,27,243,30,14,71,167,254,127,11,186,185,236,116,22,9,45,59,146,5,168,34,132,7,13,234,148,199,187,84,46,19,111,26,40,116,96,207,115,214,209,38,144,191,145,165,191,189,216,83,186,129,116,55,127,120,34,21,64,212,104,101,231,206,126,16,59,213,214,165,173,161,203,62,97,85,219,33,12,180,115,197,46,222,243,165,79,22,185,143,234,34,235,202,232,107,217,36,65,169,201,237,75,141,37,163,217,247,187,228,172,40,162,209,7,150,119,86,164,49,220,143,75,200,82,44,44,44,79,101,204,25,83,24,157,111,178,120,103,111,93,12,150,247,213,148,134,77,233,43,118,190,177,184,136,4,227,171,40,43,17,243,60,92,5,216,202,182,81,43,38,166,46,179,158,4,73,37,81,43,72,190,233,248,119,106,252,83,22,37,125,39,25,184,130,21,146,69,203,218,111,232,129,149,157,24,152,221,53,232,9,124,167,241,117,23,84,106,105,106,142,222,136,159,151,3,171,34,71,119,244,174,89,110,68,237,126,219,203,178,189,211,39,93,190,147,116,11,253,212,116,132,179,243,28,68,245,199,93,54,63,74,227,143,184,32,125,55,242,73,224,176,22,8,7,203,154,114,213,144,71,67,22,242,55,41,47,38,239,131,91,40,205,55,182,134,86,45,188,65,117,157,233,130,156,239,78,55,98,29,191,160,95,212,147,141,244,185,178,229,62,14,14,12,60,187,145,145,231,70,202,94,226,180,215,127,164,31,173,7,59,109,166,153,58,51,39,48,235,209,14,42,214,27,53,20,213,189,156,190,4,103,21,221,28,227,93,191,3,4,189,61,104,93,205,154,143,236,193,115,190,206,157,149,232,201,160,182,136,62,109,139,164,121,106,184,94,190,112,88,185,47,149,35,131,91,180,19,72,118,125,253,69,27,140,38,220,45,211,101,106,66,231,8,178,82,191,9,10,48,97,194,86,237,220,216,73,145,226,137,254,97};

    // UCHAR _in[] = {
    //     145,145,145,145,180,180,180,180,10,10,10,10,122,122,122,122,170,170,170,170,111,111,111,111,13,13,13,13,190,190,190,190,164,164,164,164,197,197,197,197,222,222,222,222,179,179,179,179,40,40,40,40,152,152,152,152,209,209,209,209,137,137,137,137,173,173,173,173,119,119,119,119,127,127,127,127,202,202,202,202,19,19,19,19,84,84,84,84,16,16,16,16,111,111,111,111,139,139,139,139,27,27,27,27,110,110,110,110,50,50,50,50,238,238,238,238,4,4,4,4,171,171,171,171,129,129,129,129,175,175,175,175,172,172,172,172,242,242,242,242,90,90,90,90,29,29,29,29,246,246,246,246,25,25,25,25,184,184,184,184,188,188,188,188,238,238,238,238,108,108,108,108,219,219,219,219,128,128,128,128,55,55,55,55,101,101,101,101,38,38,38,38,173,173,173,173,220,220,220,220,239,239,239,239,184,184,184,184,49,49,49,49,1,1,1,1,40,40,40,40,179,179,179,179,19,19,19,19,149,149,149,149,220,220,220,220,2,2,2,2,152,152,152,152,137,137,137,137,130,130,130,130,65,65,65,65,46,46,46,46,109,109,109,109,154,154,154,154,66,66,66,66,100,100,100,100,171,171,171,171,242,242,242,242,25,25,25,25,154,154,154,154,95,95,95,95,244,244,244,244,19,19,19,19,141,141,141,141,82,82,82,82,57,57,57,57,52,52,52,52,39,39,39,39,41,41,41,41,235,235,235,235,87,87,87,87,33,33,33,33,12,12,12,12,12,12,12,12,51,51,51,51,160,160,160,160,231,231,231,231
    // };

    // UCHAR _in[] = { 65, 65, 65, 65, 65, 65, 65, 65, 65, 65, 65, 65, 65, 65, 65, 65, 65, 65, 65, 65, 65, 65, 65, 65, 65, 65, 65, 65, 65, 65, 65, 65, 65, 65, 65, 65, 65, 65, 65, 65, 65, 65, 65, 65, 65, 65, 65, 65, 65, 65, 65, 65, 65, 65, 65, 65, 65, 65, 65, 65, 65, 65, 65, 65, 65, 65, 65, 65, 65, 65, 65, 65, 65, 65, 65, 65, 65, 65, 65, 65, 65, 65, 65, 65, 65, 65, 65, 65, 65, 65, 65, 65, 65, 65, 65, 65, 65, 65, 65, 65, 65, 65, 65, 65, 65, 65, 65, 65, 65, 65, 65, 65, 65, 65, 65, 65, 65, 65, 65, 65, 65, 65, 65, 65, 65, 65, 65, 65, 65, 65, 65, 65, 65, 65, 65, 65, 65, 65, 65, 65, 65, 65, 65, 65, 65, 65, 65, 65, 65, 65, 65, 65, 65, 65, 65, 65, 65, 65, 65, 65, 65, 65, 68, 65, 65, 65, 65, 65, 65, 65, 65, 65, 65, 65, 65, 65, 65, 65, 65, 65, 65, 65, 65, 65, 65, 65, 65, 65, 65, 65, 65, 65, 65, 65, 65, 65, 65, 65, 65, 65, 65, 65, 65, 65, 65, 65, 65, 65, 65, 65, 65, 65, 65, 65, 65, 65, 65, 65, 65, 65, 65, 65, 65, 65, 65, 65, 65, 65, 65, 65, 65, 65, 65, 65, 65, 65, 65, 65, 65, 65, 65, 65, 65, 65, 65, 65, 65, 65, 65, 65, 65, 65, 65, 65, 65, 65, 65, 65, 65, 65, 65, 65, 65, 65, 65, 65, 65, 65, 65, 65, 65, 65, 65, 65, 65, 65, 72, 65, 65, 65, 65, 65, 65, 65, 65, 65, 65, 65, 65, 65, 65, 65
    // };

    // UCHAR _in[] = {
    //     87,87,33,33,33,33,12,12,12,12,12,12,12,12,51,51
    // };

    UCHAR _in[] = {
        70,3,191,132,51,84,193,39,76
    };


    UCHAR _out[OUTPUT_SIZE] = { 0 };
    UCHAR _backToOriginal[OUTPUT_SIZE] = { 0 };

    INT _osz = sizeof(_in);
    INT _csz = compress(_in, _osz, _out, OUTPUT_SIZE);
    printf("csz=%d\n", _csz);

    INT _bsz = uncompress(_out, _csz, _backToOriginal, OUTPUT_SIZE);
    printf("bsz=%d\n", _bsz);
    printf("osz=%d\n", _osz);

    for (int i = 0; i < _bsz; i++) {
        // printf("%d<>%d\n", _in[i], _backToOriginal[i]);
        if (_in[i] != _backToOriginal[i]) {
            printf("%d<>%d\n", _in[i], _backToOriginal[i]);
            printf("Messages differ at %d\n", i);
            return 1;
        }
    }

// exit(1);

    // sample buffer compression test
    UCHAR in[] = {'!', '!', '!', '!', '!', '!', '!', '!', '!', 'H', 'e', 'l', 'l', 'o', ' ', 'f', 'r', 'i', 'e', 'n', 'd', 's', ',', ' ', 'H', 'e', 'l', 'l', 'o', ' ', 'w', 'o', 'r', 'l', 'd', '!', '!', '!', '!', '!', '!', '!', '!', '!'};
    UCHAR out[OUTPUT_SIZE] = { 0 };
    UCHAR backToOriginal[OUTPUT_SIZE] = { 0 };

    INT osz = sizeof(in);
    INT cidx = compress(in, osz, out, OUTPUT_SIZE);
    printf("csz=%d\n", cidx);

    INT bidx = uncompress(out, cidx, backToOriginal, OUTPUT_SIZE);
    printf("bsz=%d\n", bidx);
    printf("osz=%d\n", osz);

    // if (osz != bsz) {
    //     printf("Messages differ!\n");
    //     return 1;
    // }

    for (int i = 0; i < bidx; i++) {
        // printf("%d<>%d\n", in[i], backToOriginal[i]);
        if (in[i] != backToOriginal[i]) {
            printf("Messages differ at %d\n", i);
            return 1;
        }
    }
    printf("All good!\n");

    // randomize buffer test
#define MAX_BUFFER_SIZE 4096
#define BUFFER_COUNT 256
    for (int i = 0; i < BUFFER_COUNT; i++) {
        size_t sz = rand() % MAX_BUFFER_SIZE + 1;
        UCHAR *buf = malloc(sz);
        UCHAR *cbuf = malloc(sz * 3);
        UCHAR *back = malloc(sz * 3);
        UCHAR u;
        memset(buf, 0, sz);
        memset(cbuf, 0, sz * 3);
        memset(back, 0, sz * 3);
        for (int j = 0; j < sz; j++) {
            if (j%64==0)
                u = rand() % 254 + 1;
            buf[j] = u;
        }
        cidx = compress(buf, sz, cbuf, sz * 2);
        printf("sz:%lu cidx:%d\n", sz, cidx);
        bidx = uncompress(cbuf, cidx, back, sz * 2);
        // INT _csz = compress(_in, _osz, _out, OUTPUT_SIZE);
        printf("bidx:%d\n", bidx);
        if (sz != bidx) {
            printf("Messages sizes differ!\n");
            return 1;
        }
        for (int k = 0; k < bidx; k++) {
            if (buf[k] != back[k]) {
                printf("%d<>%d\n", buf[i], back[k]);
                printf("Messages differ at %d (%lu)\n", k, sz);

                for (int l = 0; l < sz; l++)
                    printf("%d,", buf[l]);
                printf("\n");
                for (int l = 0; l < sz; l++)
                    printf("%d,", back[l]);

                return 1;
            }
        }
        printf("test %d (%f) all good!\n", i, (float) sz / (float) cidx);
        free(buf);
        free(cbuf);
        free(back);
    }

    return 0;
}
